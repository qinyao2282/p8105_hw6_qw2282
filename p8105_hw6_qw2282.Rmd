---
title: "p8105_hw6_qw2282"
author: "Qinyao Wu"
date: "11/17/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Add packages

library(tidyverse)
library(modelr)
library(mgcv)

```

```{r}

#Make the array for the cities that need to be deleted.

delete_city = c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")

#tidy the data, change into numeric, combine city and state.

data_homicide = read.csv(file = "./data/homicide-data.csv") %>% 
  mutate(city_state = str_c(city,", ", state), 
         victim_age = as.numeric(victim_age),
         victim_race = fct_relevel(victim_race, "White")) %>% 
  select(-city, -state) %>% 
  
  #Make the resolved and unresolved binary
  
  mutate(resolved = as.numeric(disposition == "Closed by arrest")) %>% 
  filter( !(city_state %in% delete_city)) %>% 
  mutate(victim_race = forcats::fct_relevel(victim_race, ref = "White")) %>% 
  mutate(cat_race = factor(ifelse(victim_race == "White", "white", "Non-white"))) %>% 
  mutate(cat_race = relevel(cat_race, ref = "white")) 
 
#Filter the data for baltimore.

baltimore_df = 
  data_homicide %>% 
   filter(city_state == "Baltimore, MD") %>% 
  select(resolved, victim_age, cat_race, victim_sex) 

#Fit baltimore data
fit_logistic = 
  baltimore_df %>% 
  glm(resolved ~ victim_age + cat_race + victim_sex, data = ., family = binomial()) 

#tidy the result to add the odds ratios.

result_df = 
  fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate), 
         
         # Add the confidence interval
         
         ci_lower = exp(estimate - qnorm(0.975) * std.error),
         ci_upper =  exp(estimate + qnorm(0.975) * std.error)) %>% 
  filter(term == "cat_raceNon-white")

```


```{r}
#Apply the method to all the city states. 
OR_city_state = data_homicide %>% 
  select(city_state, resolved, victim_age, victim_race, victim_sex) %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(result = map(data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()))) %>%
select(-data) %>%
   #Tidy the result with broom and add the odds ratio and the confidence interval. 
  mutate(result_tidy = map(result, broom::tidy)) %>%
  unnest(result_tidy) %>% 
  mutate(OR = exp(estimate), 
         ci_lower = exp(estimate - qnorm(0.975) * std.error),
         ci_upper =  exp(estimate + qnorm(0.975) * std.error)) %>%
  select(city_state, term, log_OR = estimate, OR, p.value, ci_lower, ci_upper) %>% 
  filter(term == "victim_raceBlack") %>% 
  mutate(city_state = forcats::fct_reorder(factor(city_state), OR)) 


ggplot(OR_city_state, aes( x = city_state, y = OR)) +
  geom_point(aes(size = 5, col = "blue")) +
  
  #Add the error bar. 
  geom_errorbar(aes(x = city_state, ymin = ci_lower, ymax = ci_upper)) +
  theme(text = element_text(size = 8), axis.text.x = element_text(angle = 60, hjust = 1)) + 
  
  #Add the title and the name for x and y axis. 
  labs(
    title = "OR estimation of Different City State of Black People",
    x = "City State",
    y = "Estimation of OR of unsolved Black homicides"
  )
```

###Problem 2

```{r}
#Read the data for birthweight

data_birthweight = read.csv(file = "./data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(babysex = as.factor(babysex),
         malform = as.factor(malform),
         frace = as.factor(frace),
         mrace = as.factor(mrace))


```

```{r}
####Build model

###Use stepwise function
mult.fit = lm(bwt ~ ., data = data_birthweight)
step(mult.fit, direction = 'backward')



design_model = lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken, data = data_birthweight) 

design_model %>% 
  summary()

design_model %>% 
  broom::tidy()

data_birthweight %>% 
  add_residuals(model = design_model, var = "resid") %>% 
  add_predictions(model = design_model, var = "pred") %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point() +
  geom_smooth() + 
  #Add the title and the name for x and y axis. 
  labs(
    title = "Model Residuals v.s. Fitted Values",
    x = "Prediction values",
    y = "Residuals"
  )

```



####Model proposal

I propose this model by using Stepswise Regression Selection. And by looking at these variables, these variables are meaningful in real life circumstances, especially the baby sex, babylength and gestational age in weeks. They do have a great influence on the infants' weight. In addtion to the meanings, this model also have a high adjusted r squred value, which is 0.71. This indicates that my model explains 71% of the dataset. 

From the plot, we can observe that, when the prediction value is relatively small, usually smaller than 2000, the residual tend to be higher and the model don't have an accurate prediction. When the prediction value is larger than 2000, the residual becomes small and the prediction is accurate. 


```{r}
###Model with birth length and gaweeks
fit_lenth_gage = lm(bwt ~ blength + gaweeks, data = data_birthweight) 

data_birthweight %>% 
  modelr::add_residuals(fit_lenth_gage) %>% 
  ggplot(aes(x = gaweeks, y = resid)) + geom_violin()


###Model with three way interaction
fit_three = lm(bwt ~ blength + babysex + bhead + blength * babysex * bhead, data = data_birthweight) %>% 
  broom::tidy()

```


###Comparison between models

```{r}
cv_df = 
  crossv_mc(data_birthweight, 10) 


cv_df %>% pull(train) %>% .[[1]] %>% as_tibble


cv_df =
  cv_df %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(model_1    = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + fincome + 
    gaweeks + mheight + mrace + parity + ppwt + smoken + babysex * bhead, data = data_birthweight)),
         model_2 = map(train, ~lm(bwt ~ blength + gaweeks, data = data_birthweight)),
         model_3 = map(train, ~lm(bwt ~ blength + babysex + bhead + blength * babysex * bhead, data = data_birthweight))) %>% 
  mutate(rmse_1   = map2_dbl(model_1, test, ~rmse(model = .x, data = .y)),
         rmse_2 = map2_dbl(model_2, test, ~rmse(model = .x, data = .y)),
         rmse_3 = map2_dbl(model_3, test, ~rmse(model = .x, data = .y)))



cv_df %>% 
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()


```

